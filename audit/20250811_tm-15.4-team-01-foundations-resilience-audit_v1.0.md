---
title: "Audit — Idempotency-Key (ingestion)"
doc_kind: audit
team: team-01
team_name: foundations
tm_ids: [15.4]
scope: resilience
status: draft
version: 1.0
author: ia
related_files: [docs/spec/IDEMPOTENCY_SPEC.md, docs/spec/process-document.yaml, docs/spec/process-additional-sources.yaml, docs/spec/generate-audio.yaml]
---

# Audit — Idempotency-Key (ingestion)

#TEST: rejouement identique → même réponse (200/202) sans duplication en DB/Storage
#TEST: rejouement en cours → 409 `IDEMPOTENCY_IN_PROGRESS`
#TEST: rejouement différent → 422 `IDEMPOTENCY_KEY_REUSED_WITH_DIFFERENT_REQUEST`
#TEST: TTL expiré → nouvelle exécution permise

## Résumé (TL;DR)

- Objet: vérifier la sémantique d’idempotence sur les routes d’ingestion et l’absence de doublons.
- Décision: à compléter après exécution des tests.
- Points bloquants: stockage non transactionnel, fingerprint instable, réponses non persistées.

## Références

- Spécifications: `docs/spec/IDEMPOTENCY_SPEC.md`, `docs/spec/openapi.yaml`
- Endpoints: `process-document`, `process-additional-sources`, `generate-audio`
- Annexes: `docs/ANNEXES_PAYLOADS.md`

## Méthodologie

- Jeux d’essai: 1er appel, rejouement identique (pendant/après), rejouement différent, expiration TTL.
- Procédure: appels HTTP avec header `Idempotency-Key`, vérification stockage (status, response_body), assertions DB/Storage (pas de doublons).
- ENVs: `IDEMPOTENCY_TTL_SECONDS` (optionnel), DSN/Storage pour vérifier les side‑effects.

## Vérifications de parité

- HTTP: 202/200 renvoyés sur rejouement identique (même corps), 409 en cours, 422 si clé réutilisée avec requête différente.
- Stockage: enregistrements d’idempotence complets (status, response_status, response_body, fingerprint, TTL).
- Logs: `correlation_id` présent et codes d’erreurs explicites.

## Résultats

- Observations: à compléter.
- Écarts détectés: à compléter.
- Captures/logs: à joindre.

## Recommandations & décisions

- Actions requises: à compléter.
- Acceptation conditionnelle / Refus: à compléter.

## Limitations

- Fingerprint dépend de la normalisation du corps; toute divergence de tri/omission change l’empreinte.

## Suivi Task‑Master

- Tâches liées: 15.1 (SPEC), 15.2 (IMPL), 15.3 (TEST), 15.4 (AUDIT)
- Commandes:
  - `task-master set-status --id=15.4 --status=review`
  - `task-master set-status --id=15.4 --status=done`

## Historique des versions

- v1.0: création de l’audit

