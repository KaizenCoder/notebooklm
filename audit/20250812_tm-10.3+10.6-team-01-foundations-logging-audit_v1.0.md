---
title: "Audit — tm-10.3 + tm-10.6 (Foundations Logging)"
doc_kind: audit
team: team-01
team_name: foundations
version: 1.0
status: review
author: AI-Implementateur
tm_ids: [10.3, 10.6]
scope: logging
related_files:
  - orchestrator/src/app.ts
  - docs/spec/LOGGING_ERRORS_SPEC.md
  - orchestrator/test/contract/ready-error-shape.test.ts
  - orchestrator/test/contract/generate-audio-invalid.test.ts
  - orchestrator/test/contract/payload-validation.test.ts
---

## Résumé
- 10.3 (IMPL: logs corrélés + ErrorResponse): partiellement conforme.
  - ErrorResponse contractuel présent (codes, `correlation_id`).
  - `x-correlation-id` ajouté aux réponses; `correlation_id` présent dans les erreurs `/ready` (503 NOT_READY) et validations 4xx/5xx via `setErrorHandler`.
  - Journalisation par étape: présente pour `process-document` (évènement `doc.processed` incluant `correlation_id`). Absente pour chat et generate-audio.
  - Corrélation des logs: Fastify logge `reqId`; pas de champ explicite `correlation_id` injecté dans toutes les lignes de logs applicatives.
- 10.6 (IMPL: redaction secrets + sampling): non implémenté.
  - Aucune redaction explicite des secrets (ex.: `Authorization`) dans les logs applicatifs.
  - Pas de sampling ni de métriques latences dans les logs au format attendu.

## Vérifications (extraits)
- ErrorResponse `/ready` 503:
  - Code attendu `NOT_READY`, `details` présents, `correlation_id` présent.
- Erreurs 4xx (ex.: payload invalide, generate-audio manquant `notebook_id`):
  - 422 avec `{ code, message, correlation_id }`.
- Journalisation par étape `process-document`:
  - Évènement JSON `doc.processed` avec `correlation_id`, `timings_ms`, `chunks`.

## Constat de parité vs SPEC
- `docs/spec/LOGGING_ERRORS_SPEC.md` exige:
  - Logs JSON avec `correlation_id` systématique et `event_code` par étape (extract/embed/rag/tts/upload/callback).
  - Redaction de champs sensibles.
  - Modèle d’erreurs stable.
- Écarts:
  - `correlation_id` non injecté uniformément dans tous les logs (seulement `reqId` Fastify et l’évènement `doc.processed`).
  - Manque d’évènements étape pour chat et audio.
  - Redaction non implémentée.

## Recommandations
- Injecter `correlation_id` dans le contexte logger (hook per-request) et l’ajouter à toutes les lignes applicatives.
- Ajouter des évènements `RAG_START/COMPLETE`, `MATCH_DOCS_*`, `TTS_*`, `UPLOAD_*`, `CALLBACK_SENT`.
- Implémenter une fonction de redaction (headers/body) et désactiver/retirer `Authorization` des logs.
- Ajouter métriques de latence dans `details` (`extract_duration_ms`, `embed_duration_ms`, `rag_duration_ms`, `tts_duration_ms`).

#TEST: orchestrator/test/contract/ready-error-shape.test.ts
#TEST: orchestrator/test/contract/generate-audio-invalid.test.ts
#TEST: orchestrator/test/contract/payload-validation.test.ts

## Limitations
- L’audit s’appuie sur l’exécution locale des tests contractuels et d’intégration actuels; pas de tests de redaction/sampling dédiés.
- Les logs Fastify par défaut ne contiennent pas les headers; le risque d’exposition de secrets reste faible mais non explicitement mitigé par une redaction applicative.
