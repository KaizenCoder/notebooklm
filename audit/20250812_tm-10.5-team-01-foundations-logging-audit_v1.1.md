---
title: "Audit — tm-10.5 Foundations Logging (parité & erreurs)"
doc_kind: audit
team: team-01
team_name: foundations
version: 1.1
status: review
author: AI-Implementateur
tm_ids: [10.5]
scope: logging
related_files:
  - docs/spec/LOGGING_ERRORS_SPEC.md
  - docs/spec/openapi.yaml
  - orchestrator/src/app.ts
  - orchestrator/test/integration/logging-redaction.test.ts
  - orchestrator/test/contract/ready-error-shape.test.ts
  - orchestrator/test/contract/generate-audio-invalid.test.ts
  - orchestrator/test/contract/payload-validation.test.ts
---

## Résumé
- Parité logging & erreurs: conforme aux exigences clés de `LOGGING_ERRORS_SPEC.md`.
  - Logs JSON présents avec `correlation_id` et logs d’étapes (RAG/TTS/UPLOAD/CALLBACK) — RAG et audio couverts; `process-document` expose déjà un évènement `doc.processed` structuré avec timings.
  - Redaction: header `Authorization` masqué (`[REDACTED]`) dans les logs génériques de réponse; test dédié ajouté.
  - Modèle d’erreurs contractuel: `ErrorResponse` retourné pour 401/422 et `NOT_READY` 503 avec `details`.
- Points restants (non bloquants pour 10.5): métriques latences détaillées pour chat (au-delà de `rag_duration_ms`) et redaction étendue récursive (introduite, prête si de nouveaux champs apparaissent).

## Références & preuves
- Tests exécutables (OK):
  - `orchestrator/test/integration/logging-redaction.test.ts` — vérifie la redaction `Authorization`.
  - `orchestrator/test/contract/ready-error-shape.test.ts` — valide 503 `NOT_READY` avec `details` et `correlation_id`.
  - `orchestrator/test/contract/generate-audio-invalid.test.ts` — 422 et `ErrorResponse` conforme.
  - `orchestrator/test/contract/payload-validation.test.ts` — 202 transitoire, `ErrorResponse` conforme dans invalid.
- Implémentation: hooks `onSend` (header `x-correlation-id`) et `onResponse` (log structuré redacted), events étape pour chat/audio.

#TEST: orchestrator/test/integration/logging-redaction.test.ts
#TEST: orchestrator/test/contract/ready-error-shape.test.ts
#TEST: orchestrator/test/contract/generate-audio-invalid.test.ts
#TEST: orchestrator/test/contract/payload-validation.test.ts

## Constat détaillé
- `correlation_id`: présent dans toutes les erreurs; ajouté en header `x-correlation-id` pour traçabilité côté client/tests.
- `event_code`: `RAG_*` et `TTS/UPLOAD/CALLBACK_*` présents; `process-document` expose `doc.processed` avec `timings_ms`.
- Redaction: mascarade `Authorization` + fonction de redaction récursive prête à être utilisée avec d’autres champs sensibles.

## Recommandations
- Étendre les métriques de latence chat (temps de match_documents) si requis par l’original.
- Converger `process-document` vers des events `EXTRACT/EMBED/UPSERT_*` si nécessaire pour parité fine de logs.

## Limitations
- Les logs d’étapes côté `process-document` restent regroupés via l’évènement synthétique `doc.processed`; granularité step‑by‑step à implémenter au besoin.

## Statut de conformité
- Conforme pour 10.5 sous réserve des recommandations ci‑dessus.
