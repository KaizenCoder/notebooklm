---
title: "MOV Audit — tm-15.2 + tm-15.3 + tm-19.2 (Foundations)"
doc_kind: audit
team: team-01
author: AI-Auditeur
team_name: foundations
version: 1.0
status: reviewed
tm_ids: [15.2, 15.3, 19.2]
scope: idempotency + ingestion texte + hooks NO_MOCKS
related_files:
  - orchestrator/src/app.ts
  - orchestrator/test/contract/idempotency.test.ts
  - orchestrator/test/contract/idempotency-additional-sources.test.ts
  - orchestrator/test/integration/process-document-callbacks.test.ts
  - ci/no-mocks-check.ps1
  - ci/anti-mock-scan.ps1
---

## Résumé
- Idempotency (15.2/15.3): Comportement conforme — replays avec le même `Idempotency-Key` renvoient la même réponse et n'occasionnent pas de doublons d'effets.
- Ingestion texte (19.2): Flot `process-document` exécuté avec callbacks; événements de pipeline émis; aucune dépendance réseau externe non mockée.
- Hooks NO_MOCKS (pré-push local): présents; l'audit confirme la présence et l'exécutabilité des scripts de contrôle anti-mock.

## Preuves (#TEST)
#TEST: orchestrator/test/contract/idempotency.test.ts
#TEST: orchestrator/test/contract/idempotency-additional-sources.test.ts
#TEST: orchestrator/test/integration/process-document-callbacks.test.ts
#TEST: ci/no-mocks-check.ps1
#TEST: ci/anti-mock-scan.ps1

## Constats détaillés
- Idempotency:
  - Requêtes `POST /webhook/process-document` et `POST /webhook/process-additional-sources` avec le même `Idempotency-Key` retournent des réponses cohérentes et n'exécutent pas deux fois les effets.
  - Les tests couvrent les deux cas: document et additional-sources.
- Ingestion texte:
  - Le pipeline trace les étapes `EXTRACT`/`EMBED`/`UPSERT` et les callbacks sont émis (succès, host local capturé).
- NO_MOCKS hooks:
  - `ci/no-mocks-check.ps1` présent; politique anti-mock vérifiée en local (exécution possible, contrôle des variables d'environnement critiques).
  - `ci/anti-mock-scan.ps1` présent; scan anti-mock disponible.

## Exemples de logs (anonymisés)
```json
{"event":"doc.processed","correlation_id":"req-123","timings_ms":{"extract":1,"embed":0,"upsert":0,"total":1},"chunks":1}
{"level":30,"correlation_id":"req-abc","route":"/webhook/generate-audio","event_code":"CALLBACK_SENT","callback_host":"127.0.0.1:61234"}
{"level":30,"route":"/webhook/process-document","method":"POST","headers":{"authorization":"[REDACTED]"},"msg":"request complete"}
```

## Conclusion
- Les exigences MOV pour tm-15.2/15.3 (idempotency) et tm-19.2 (ingestion texte) sont respectées.
- Les hooks NO_MOCKS sont présents et alignés avec les exigences de contrôle local.

## Limitations
- Les scripts NO_MOCKS requièrent un environnement local prêt (Docker/ENVs) pour une exécution complète.
- Les extraits de logs ci-dessus sont issus d'exécutions locales et anonymisés (pas de secrets ni d'URLs sensibles).
