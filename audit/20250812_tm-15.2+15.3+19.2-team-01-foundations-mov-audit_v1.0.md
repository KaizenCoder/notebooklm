---
title: "MOV: Idempotency 15.2/15.3 + Ingestion texte 19.2 + hooks no‑mocks"
doc_kind: audit
team: team-01
team_name: foundations
tm_ids: [15.2, 15.3, 19.2, 12.3]
scope: process-document|idempotency|hooks
status: draft
version: 1.0
author: ia
related_files: [
  "orchestrator/src/app.ts",
  "orchestrator/src/services/document.ts",
  "orchestrator/src/services/db.ts",
  "orchestrator/test/contract/idempotency.test.ts",
  "orchestrator/test/contract/idempotency-additional-sources.test.ts"
]
---

# Audit — MOV: Idempotency 15.2/15.3 + Ingestion texte 19.2 + hooks no‑mocks

#TEST: orchestrator/test/contract/idempotency.test.ts
#TEST: orchestrator/test/contract/idempotency-additional-sources.test.ts

## Résumé (TL;DR)

- Objet: Vérifier idempotence (replays sans doublon) et ingestion texte `process-document` (callbacks) en mode MOV; valider l’existence d’un verrou no‑mocks.
- Décision: Idempotency + ingestion texte: conforme (tests PASS). No‑mocks hooks: conditionnel (preuve partielle dans package.json, artefacts CI non trouvés).
- Points bloquants: scripts `ci/no-mocks-check.ps1` et `ci/anti-mock-scan.ps1` non présents dans l’arborescence lue; pré‑push antérieur signalé en échec format.

## Références

- Spécifications: `docs/TECHNICAL_GUIDELINES.md`
- OpenAPI: `docs/spec/openapi.yaml`
- Annexes payloads: `docs/ANNEXES_PAYLOADS.md`

## Méthodologie

- Jeux d’essai: Suite contractuelle complète, focus `idempotency*.test.ts` et `process-document*`.
- Procédure: Exécution `npm run -s test:contract`; inspection `src/app.ts` pour sémantique Idempotency-Key + callbacks.
- ENVs: `GPU_ONLY=1` (via scripts), modèles Ollama simulés par mocks tests.

## Vérifications de parité

- HTTP (statuts, payloads, entêtes): Idempotency-Key honorée; replays retournent même statut/payload.
- Side‑effects DB: Insertion/updates protégées par cache idem; pas de doublon observé dans tests.
- Logs & erreurs: Format `ErrorResponse` respecté; `correlation_id` propagé.

## Résultats

- Observations: `process-document` envoie callbacks success/failed dans job; Idempotency store TTL active sur routes ingestion (document/additional-sources).
- Écarts détectés: Manque de preuve CI/no‑mocks (scripts référencés dans le claim non présents dans repo visible).
- Captures/logs: Voir sorties de `test:contract` (PASS) durant l’audit.

## Recommandations & décisions

- Actions requises:
  - Ajouter les scripts `ci/no-mocks-check.ps1` et `ci/anti-mock-scan.ps1` au repo et un job local pour preuve.
  - Corriger/preparer le hook `pre-push.ps1` et documenter la commande d’installation (`npm run prepare:hooks`).
- Acceptation conditionnelle / Refus: Acceptation conditionnelle — MOV OK hors verrou no‑mocks à prouver par artefacts.

## Limitations

- Audit ne couvre pas PDF/ASR/TTS réels; hors périmètre MOV.

## Suivi Task‑Master

- Tâches liées: 15.2, 15.3, 19.2, 12.3
- Commandes:
  - `task-master set-status --id=15 --status=done` (après validation finale)
  - `task-master set-status --id=12 --status=review` (verrou no‑mocks/CI)

## Historique des versions

- v1.0: création de l’audit
