---
title: "Logging Metrics - Métriques latences chat et événements process-document"
doc_kind: claim
team: team-01
team_name: foundations
tm_ids: ["10.12", "10.13"]
scope: logging
status: draft
version: 1.0
author: ia
related_files:
  - orchestrator/src/app.ts
  - orchestrator/src/services/document.ts
  - orchestrator/test/contract/chat-llm-metrics.test.ts
  - orchestrator/test/contract/process-document-job.test.ts
---

# Claim — Logging Metrics — Métriques latences chat et événements process-document

#TEST: orchestrator/test/contract/chat-llm-metrics.test.ts
#TEST: orchestrator/test/contract/process-document-job.test.ts

## Résumé (TL;DR)

- **Problème constaté:** Métriques de latences chat et événements étapes process-document manquants dans les logs pour observabilité complète
- **Proposition succincte:** Finaliser l'implémentation des métriques `match_documents_ms`/`llm_generate_ms`/`rag_duration_ms` pour chat et événements `EXTRACT/EMBED/UPSERT_COMPLETE` pour process-document
- **Bénéfice attendu:** Observabilité complète des performances avec correlation_id pour debugging et monitoring opérationnel

## Contexte

- **Contexte fonctionnel:** Système de logging structuré pour monitoring des performances des workflows RAG et ingestion de documents
- **Contexte technique:** Événements logs JSON avec `correlation_id` pour traçabilité end-to-end des requêtes
- **Références:** `docs/spec/LOGGING_ERRORS_SPEC.md`, audits existants dans `audit/20250812_tm-10.5-*.md`

## Portée et périmètre (scope)

- **Équipe:** team-01 / foundations
- **Tâches Task‑Master visées:** 10.12, 10.13
- **Endpoints/domaines:** logging, chat, process-document

## Demande et motivation

- **Description détaillée:**
  - Task 10.12: Implémentation des métriques de latences détaillées pour le workflow chat RAG
  - Task 10.13: Finalisation des événements structurés pour les étapes process-document avec correlation_id
  
- **Justification:** 
  - Parité avec patterns logging originaux
  - Observabilité opérationnelle pour monitoring des performances
  - Debug facilité avec correlation_id cohérent
  - Métriques business pour optimisation workflows

## Critères d'acceptation

- [x] **CA1:** Métriques chat - événement `RAG_COMPLETE` contient `rag_duration_ms`, `match_documents_ms`, `llm_generate_ms`
- [x] **CA2:** Événements process-document - `EXTRACT_COMPLETE`, `EMBED_COMPLETE`, `UPSERT_START/COMPLETE` avec `correlation_id`
- [x] **CA3:** Tests contractuels validant la présence des métriques et événements
- [x] **CA4:** Correction cohérence `correlation_id` (utilisation de `req.id` au lieu de `req.correlationId`)

## Impacts

- **API/Contrats I/O:** Aucun impact sur les contrats HTTP externes
- **Code & modules:**
  - `orchestrator/src/app.ts`: événements RAG avec métriques timing
  - `orchestrator/src/services/document.ts`: événements étapes avec correlation_id
- **Schéma/DB/Storage:** Aucun impact
- **Performance/latences:** Impact négligeable (ajout logs structurés)
- **Sécurité/compliance:** Amélioration observabilité pour security monitoring

## Implémentation Réalisée

### Task 10.12 - Métriques latences chat

**Localisation:** `orchestrator/src/app.ts` ligne ~167

```typescript
const rag_total_ms = t1 - t0;
const match_ms = tMatchStart && tMatchEnd ? (tMatchEnd - tMatchStart) : null;
app.log.info({ 
  correlation_id: (req as any).id, 
  event_code: 'RAG_COMPLETE', 
  route: '/webhook/chat', 
  rag_duration_ms: rag_total_ms, 
  match_documents_ms: match_ms, 
  llm_generate_ms: tGen1 - tGen0 
}, 'RAG complete');
```

**Test validé:** `chat-llm-metrics.test.ts` ✅

### Task 10.13 - Événements EXTRACT/EMBED/UPSERT 

**Localisation:** `orchestrator/src/services/document.ts`

```typescript
// Événements avec correlation_id
console.log(JSON.stringify({ 
  event: 'EXTRACT_COMPLETE', 
  correlation_id: payload.correlationId ?? null, 
  extract_duration_ms: tExtractEnd - tExtractStart 
}));

console.log(JSON.stringify({ 
  event: 'EMBED_COMPLETE', 
  correlation_id: payload.correlationId ?? null, 
  embed_duration_ms: t2 - tEmbedStart, 
  chunks: chunks.length 
}));

console.log(JSON.stringify({ 
  event: 'UPSERT_COMPLETE', 
  correlation_id: payload.correlationId ?? null, 
  upsert_duration_ms: t3 - t2, 
  count: docs.length 
}));
```

**Correction appliquée:** Cohérence `correlationId` → `req.id` dans les appels depuis `app.ts`

**Test validé:** `process-document-job.test.ts` ✅

## Tests de Validation

### Résultats Tests Contractuels

```bash
npx tsx test/contract/chat-llm-metrics.test.ts
# ✅ PASS - Validation présence llm_generate_ms dans RAG_COMPLETE

npx tsx test/contract/process-document-job.test.ts  
# ✅ PASS - Validation événements EXTRACT/EMBED/UPSERT avec correlation_id
```

### Logs Exemples (Anonymisés)

**Chat Metrics:**
```json
{
  "level": 30,
  "correlation_id": "req-1", 
  "event_code": "RAG_COMPLETE",
  "route": "/webhook/chat",
  "rag_duration_ms": 21,
  "match_documents_ms": 0,
  "llm_generate_ms": 17
}
```

**Process-Document Events:**
```json
{"event": "EXTRACT_COMPLETE", "correlation_id": "req-1", "extract_duration_ms": 0}
{"event": "EMBED_COMPLETE", "correlation_id": "req-1", "embed_duration_ms": 0, "chunks": 1}
{"event": "UPSERT_START", "correlation_id": "req-1", "count": 1}
{"event": "UPSERT_COMPLETE", "correlation_id": "req-1", "upsert_duration_ms": 1, "count": 1}
{"event": "doc.processed", "correlation_id": "req-1", "timings_ms": {"extract": 0, "embed": 0, "upsert": 1, "total": 8}, "chunks": 1}
```

## Risques et alternatives

- **Risques:** 
  - Volume de logs augmenté (impact négligeable)
  - Dépendance à la cohérence du `correlation_id`
  
- **Atténuations:** 
  - Logs structurés optimisés JSON
  - Tests contractuels validation automatique
  
- **Alternatives évaluées:** 
  - Métriques externes (Prometheus) - reporté pour simplicité
  - Sampling logs - implémenté via `logging-sampling.test.ts`

## Références

- **Spécifications:** `docs/spec/LOGGING_ERRORS_SPEC.md`
- **Audits existants:** `audit/20250812_tm-10.5-team-01-foundations-logging-audit_v1.1.md`
- **Tests contractuels:** `orchestrator/test/contract/chat-llm-metrics.test.ts`, `process-document-job.test.ts`

## Limitations

- Ce claim se concentre uniquement sur l'observabilité logging, pas sur les métriques business exportées
- Les durées sont mesurées côté application (sans granularité réseau/DB)
- Compatibilité maintenue avec l'implémentation existante sans breaking changes

## Suivi Task‑Master

- **Tâches liées:** 10.12, 10.13  
- **Status final:** `done` ✅
- **Commandes appliquées:**
  - `task-master set-status --id=10.12 --status=done`
  - `task-master set-status --id=10.13 --status=done`

## Preuves et Traçabilité

- **Implémentation:** `orchestrator/src/app.ts` (chat metrics), `orchestrator/src/services/document.ts` (events)
- **Tests:** 27/27 tests contractuels PASS, incluant `chat-llm-metrics` et `process-document-job`
- **Validation régression:** `npm run test:contract` - tous tests PASS
- **Logs produits:** Événements structurés avec `correlation_id` cohérent

## Historique des versions

- v1.0: création du claim post-implémentation Tasks 10.12 et 10.13 complétées
