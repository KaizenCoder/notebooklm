---
title: "MOV: Idempotency 15.2/15.3 + Ingestion texte 19.2 + hooks no-mocks"
doc_kind: claim
team: team-01
team_name: foundations
tm_ids: [15.2, 15.3, 19.2, 12.3]
scope: process-document|idempotency|hooks
status: review
version: 1.0
author: ia
related_files:
  - orchestrator/src/app.ts
  - orchestrator/src/services/document.ts
  - orchestrator/src/services/db.ts
  - orchestrator/test/contract/*.test.ts
  - orchestrator/test/integration/*.test.ts
  - ci/no-mocks-check.ps1
  - ci/anti-mock-scan.ps1
---

## Résumé
Basculer en mode MOV (produit observable rapide):
- Idempotency middleware/store opérationnel (15.2) + tests de relecture (15.3)
- Ingestion texte via /webhook/process-document avec callbacks (19.2)
- Hooks pré‑push (no‑mocks + anti‑mock) verrouillés

## Détails
- Idempotency: implémentation TTL store + clés (header `Idempotency-Key`) appliquée à `process-document` et `process-additional-sources`.
- Ingestion texte: `docProc.processDocument` gère texte direct + upload texte additionnel.
- Callbacks: envoi `completed/failed` pour `process-document`, `success/failed` pour `generate-audio`.
- Hooks: `.git/hooks/pre-push.ps1` force `NO_MOCKS=1` → `ci/anti-mock-scan.ps1` + `ci/no-mocks-check.ps1`.

## Impact
- Fonctionnel MOV activé (chat + ingestion texte + citations + idempotency + no‑mocks).
- Sécurité de non‑contournement renforcée.

## Preuves
#TEST: orchestrator/test/contract/idempotency.test.ts
#TEST: orchestrator/test/contract/idempotency-additional-sources.test.ts
#TEST: orchestrator/test/integration/process-document-callbacks.test.ts
#TEST: ci/no-mocks-check.ps1
#TEST: ci/anti-mock-scan.ps1

## Limitations
- PDF réel, ASR et TTS réels restent à intégrer pour la parité complète.
- Les callbacks ne vérifient pas le retour HTTP effectif du consumer (simulé en tests).
