import { createDocumentProcessor } from '../../src/services/document.js';

const env = { OLLAMA_EMBED_MODEL: 'nomic-embed-text' } as any;
const fakeOllama = { embeddings: async (_m: string, _p: string) => Array.from({ length: 768 }, () => 0.5) } as any;
const fakeDb = { upsertDocuments: async (_: any[]) => {} } as any;

const docProc = createDocumentProcessor(env, { ollama: fakeOllama as any, db: fakeDb });

// Texte avec motifs répétés pour stresser le mapping loc.lines
// 10 lignes identiques suivies de 10 lignes identiques différentes
const linesA = Array.from({ length: 10 }, () => 'alpha alpha alpha alpha alpha').join('\n');
const linesB = Array.from({ length: 10 }, () => 'beta beta beta beta beta').join('\n');
const text = `${linesA}\n${linesB}`;

const res = await docProc.processDocument({ notebookId: 'nb-rep', sourceId: 's-rep', text });
if (!res || typeof res.chunks !== 'number' || res.chunks < 2) {
  console.error('expected multiple chunks for repeated text');
  process.exit(1);
}

console.log('PASS chunking-loc-lines-repeats');
